# Execute a Presentation Query using CLI tools

The main challenge is, that DCP does not use static tokens, but requires the API client to generate a token of their own, based on an access token they had received earlier.

## Terminology

For the purposes of this, these terms and definitions apply:

- client: the entity that executes a HTTP request to obtain verifiable presentations from the IdentityHub. Here, that is `curl` being executed on a shell.
- ID token: a self-issued JWT signed with the holder's private key. Some ID tokens contain an _access token_.
- access token: an opaque string generated by the SecureTokenService.

## Required tools

The following tools are **mandatory** and must be installed beforehand:

- a POSIX-compliant shell, e.g. `bash`, `zsh`...
- Java 17+
- Docker
- `curl` to make HTTP requests
- `jq` to parse JSON
- [jose](https://github.com/nao1215/jose), to create JWT and JWS objects. Note that we are _not_ using the JWK generation facility of it.
- python 3 and pip (`python3 -m ensurepip --upgrade` to install `pip`)
- a running instance of IdentityHub with a pre-configured `"super-user"` admin role.

## Preparation: create keys and user accounts

### 1. Generate a key pair for the client

```shell
java -jar json-web-key-generator.jar -t EC -c P-256 -u sig --id "did:web:localhost%3A9876#key-1" -o private.jwk -P public.jwk
```

this generates a public key (`public.jwk`) and a private key (`private.jwk`) in the current directory, both in JWK format.

### 2. Update the client's DID document

The following command adds the public key we've just created to the client's DID document, so it is resolvable via the network by IdentityHub:

```shell
jq --slurpfile pk public.jwk '.verificationMethod.[0].publicKeyJwk = $pk[0]' did.template.json > did.json
```

### 3. Run NGINX as DID hoster

to make the DID document resolvable, we need a static web endpoint that hosts the DID document. For that, NGINX is a good and widely available choice. Note that the NGINX docker container must be reachable by IdentityHub. The following command spins up NGINX in a docker container, using the [configuration file](./nginx.conf) and the DID document we generated in the previous step.

```shell
docker run -d --name nginx -p 9876:80 --rm \
  -v "$PWD"/nginx.conf:/etc/nginx/nginx.conf:ro \
  -v "$PWD"/did.json:/var/www/.well-known/did.json:ro \
  nginx
```

### 4. Create User account on IdentityHub

So far, IdentityHub only contains an admin account, which is not usable for DCP Presentation Requests. We must therefore create a user account, passing the client ID (`"did:web:localhost%3A7083"`) and storing the resulting client secret in a variable: 

```shell
secret=$(./create_user.sh "did:web:localhost%3A7083")
```

### 5. Obtain access token from STS

In a normal DSP interaction, this would be generated and sent by the consumer. Here, we don't have any DSP messages, so we must emulate this by manually generating the ID token (Which contains the access token) using IdentityHub's STS API:

```shell
accessToken=$(./get_token.sh $secret)
```

this performs a REST request against the STS API, parses the resulting ID token and extracts the access token. Please verify that the `accessToken` has the correct format. We can do this by decoding the access token: 

```shell
./decode.sh $(echo $accessToken | cut -d '.' -f2) | jq
``` 
which produces something like this:
```json
{
  "aud": "did:web:localhost%3A7083",
  "sub": "did:web:localhost%3A7083",
  "nbf": 1741776541,
  "scope": "org.eclipse.edc.vc.type:MembershipCredential:read",
  "iss": "did:web:localhost%3A7083",
  "exp": 1741776841,
  "iat": 1741776541,
  "jti": "accesstoken-1bc7b80a-dfe3-4cbe-aad9-a8e6b549d017"
}
```

note that `exp`, `iat` and `jti` might be slightly different due to their dynamic nature.

## Execute a Presentation Query 

Now that we've successfully obtained an access token for IdentityHub, we still must "wrap" it in another ID token. For that, we use the tool `jose`.

```shell
# generate token payload
cat id_token_template.json| jq '.token=$accessToken' --arg accessToken $accessToken > payload.json

# generate + sign ID token
idToken=$(jose jws sign --algorithm ES256 --key private.jwk -F json payload.json)
```

Notice how this uses the previously generated private key (`private.jwk`) to sign the token. Again, to verify that the ID token has the correct format, we can decode it:

```shell
./decode.sh $(echo $idToken | cut -d '.' -f2) | jq
```

which should produce a JSON structure like this:

```json
{
  "aud": "did:web:localhost%3A7083",
  "sub": "did:web:localhost%3A7083",
  "iss": "did:web:localhost%3A9876",
  "exp": 1741696799,
  "jti": "c54ea3ac-b840-41d0-a4f0-4d07b1338a80",
  "client_id": "did:web:localhost%3A9876",
  "token": "eyJra...."
}
```

Finally, with that ID token, we can execute a DCP Presentation Query against IdentityHub to request Verifiable Presentations:

```shell
curl -sL 'http://localhost:7081/api/credentials/v1/participants/ZGlkOndlYjpsb2NhbGhvc3QlM0E3MDgz/presentations/query' \
--header 'Content-Type: application/json' \
--header "Authorization: Bearer ${idToken}" \
--data-raw '{
    "@context": [
        "https://identity.foundation/presentation-exchange/submission/v1",
        "https://w3id.org/dspace-dcp/v1.0/dcp.jsonld"
    ],
    "@type": "PresentationQueryMessage",
    "scope": [
        "org.eclipse.edc.vc.type:MembershipCredential:read"
    ]
}' | jq
```

## Run stress tests

Several tools exist, for example `ab` (Apache Benchmark), `wrk` and `locust` and for the purposes of this document we'll focus on `locust` (<https://locust.io>) because it appears to be the most versatile and even comes with a dashboard.

To install, simply run `pip install locust`. On some machines, installing this in the global python environment is disallowed. In those cases a virtual environment (venv) must be created:

```shell
python3 -m venv perftest
source perftest/bin/activate # for unix/macos
```

There is a preconfigured locust file (`locustfile.py`) which assumes to find the ID token in an environment variable `ID_TOKEN`. Thus, we are going to export our shell variable `idToken` from earlier:

```shell
export ID_TOKEN=$idToken
```

and then we can run

```shell
locust -f locustfile.py --host http://localhost:7081/api/credentials/v1/participants/ZGlkOndlYjpsb2NhbGhvc3QlM0E3MDgz
```

notice that the `--host` argument specifies the base URL, the API endpoint (`/api/presentation`) is specified inside the locust file. On locust's dashboard (by default at `http://0.0.0.0:8089`) we can configure things like overall runtime, peak users and ramp-up.

## Caveats and noteworthy things

tokens expire - if something starts to fail along the way, simply restart the sequence from [obtaining the access token](#5-obtain-access-token-from-sts).

